# StudySmart App: Technical Specification & Documentation

This document outlines the complete architecture, data flow, screen-by-screen logic, and database schema for the StudySmart application.

---
## 1. Core App Architecture & Entry Flow
---

The application is built on a modular, service-oriented architecture that separates UI, business logic, and data services.

**Entry Point (`main.dart`):**
- **Purpose:** Initializes Firebase and acts as the primary authentication gatekeeper.
- **Logic:**
    1. It uses a `StreamBuilder` to listen to the `AuthService().userStream`. This is a robust stream that emits a `User` object whenever the authentication state changes (login, logout, app start).
    2. **If `snapshot.hasData` (a user is logged in):** The app navigates to the `HomeScreen`. The `userStream` in `AuthService` also triggers the creation of the user's document in Firestore if it doesn't exist.
    3. **If `!snapshot.hasData` (no user is logged in):** The app navigates to the `AuthPage`.

---
## 2. Data Layer: Firestore Collections & Data Models
---

This section describes the "source of truth" for all application data.

### Collection: `users`
- **Purpose:** Stores a profile for each authenticated user and their aggregate performance statistics.
- **Document ID:** User's Firebase Auth UID.
- **When Created:** A document is automatically created the first time a user authenticates, via any method (Google or Email/Password).
- **Dart Model:** `lib/user_model.dart` (`UserModel`, `UserStats`)
- **Schema:**
    - `uid` (String): The user's unique Firebase Auth ID.
    - `email` (String): The user's email address.
    - `displayName` (String): The user's chosen display name.
    - `stats` (Map): A nested object for performance metrics.
        - `testsTaken` (int): Counter for completed tests.
        - `questionsSolved` (int): Counter for answered questions.
        - `averageAccuracy` (double): Rolling average accuracy.

### Collection: `static_data`
- **Purpose:** Stores static, foundational data for the app.
- **Document:** A single document with the ID `syllabus`.
- **Schema (`syllabus` doc):**
    - `subjects` (Map) -> `physics` (Map) -> `chapters` (Map) -> `[chapter_id]` (Map) -> `name` (String), `topics` (Map) -> `[topic_id]` (String: topic_name).

### Collection: `questions` (Existing)
- **Purpose:** The central repository for all question content.
- **Document ID:** A unique ID for each question.
- **Dart Model:** `lib/question_model.dart` (`Question`)
- **Schema:**
    - `chapterId` (String): Foreign key to a chapter.
    - `topicId` (String): Foreign key to a topic.
    - `Correct Answer` (String): The correct answer key.
    - `image_url` (String): URL for the question image.
    - `solution_url` (String): URL for the solution image.
    - `Question type` (String): "Single Correct" or "Numerical type".

### Collection: `tests` (The Blueprint)
- **Purpose:** Stores the definition of a generated test.
- **Document ID:** Auto-generated by Firestore.
- **When Created:** When a user clicks "Attempt now" or "Attempt later" on the `TestPreviewScreen`.
- **Dart Model:** `lib/test_model.dart` (`TestModel`, `TestConfig`)
- **Schema:**
    - `createdBy` (String): The UID of the user.
    - `createdAt` (Timestamp): When the test was generated.
    - `status` (String): "Not Attempted" or "Attempted".
    - `testName` (String): The user-defined name.
    - `config` (Map):
        - `durationSeconds` (int)
        - `totalQuestions` (int)
    - `questionIds` (List<String>): List of question document IDs.
    - `chapters` (List<String>): List of chapter names.

### Collection: `attempts` (The Execution Log)
- **Purpose:** Stores the detailed results of a single test attempt.
- **Document ID:** Auto-generated by Firestore.
- **When Created:** When a user taps "Submit" on the `TestScreen`.
- **Dart Model:** `lib/attempt_model.dart` (`AttemptModel`, `ResponseObject`)
- **Schema:**
    - `testId` (String): Foreign key to `tests`.
    - `userId` (String): Foreign key to `users`.
    - `completedAt` (Timestamp).
    - `score` (int): Final marks (+4 for correct, -1 for incorrect).
    - `timeTakenSeconds` (int).
    - `responses` (Map): Key is a `questionId`.
        - `[questionId]` (Map - `ResponseObject`):
            - `status` (String): "CORRECT", "INCORRECT", "SKIPPED", "REVIEW".
            - `selectedOption` (String | null).
            - `correctOption` (String).
            - `timeSpent` (int): Seconds spent on the question.
            - `visitCount` (int).
            - `q_no` (int): The question number in the test (1, 2, ...).

---
## 3. UI Layer: Screen-by-Screen Breakdown
---

This section describes each screen's purpose, UI, and core logic.

### `AuthPage`
- **File:** `lib/auth_page.dart`
- **Purpose:** Toggles between the Login and Register screens.
- **UI:** None. It's a logic container.
- **Logic:** Holds a boolean `_showLoginScreen` to decide which screen to build. Passes a `toggleScreens` callback to its children.

### `LoginScreen`
- **File:** `lib/Screens/login_screen.dart`
- **Purpose:** Handles existing user sign-in.
- **UI:** Email/Password fields, "Sign In" button, "Sign in with Google" button, link to Register.
- **Logic:** Uses `AuthService` methods for both email and Google sign-in.

### `RegisterScreen`
- **File:** `lib/register_screen.dart`
- **Purpose:** Handles new user registration.
- **UI:** Display Name, Email, Password fields, "Sign Up" button, link to Login.
- **Logic:** Uses `AuthService().signUpWithEmailAndPassword()`.

### `HomeScreen`
- **File:** `lib/home_screen.dart`
- **Purpose:** The main app dashboard after login.
- **UI:** A central "Create your own test" button and a side `Drawer`.
- **Logic:**
    - The main button navigates to the `CustomTestHistoryScreen`.
    - The `Drawer` contains a "Logout" button calling `AuthService().signOut()`.

### `CustomTestHistoryScreen`
- **File:** `lib/custom_test_history_screen.dart`
- **Purpose:** Displays a list of all custom tests generated by the user.
- **UI:** Filter chips ("All", "Attempted", "Not Attempted"), a list of test cards, and a "Create new custom test" FAB.
- **Logic:**
    - Uses a `StreamBuilder` to listen to `TestOrchestrationService().getSavedTestsStream()` for a live list of tests.
    - Filters the list based on the selected chip.
    - "Attempt now" button fetches questions via `TestOrchestrationService` and navigates to `TestScreen`.

### `SyllabusScreen`
- **File:** `lib/Screens/syllabus_screen.dart`
- **Purpose:** Starting point for creating a new test.
- **UI:** An expandable list of chapters, revealing a grid of its topics. A sticky bottom bar appears when items are selected.
- **Logic:**
    - Fetches syllabus from `/static_data/syllabus`.
    - Manages a `Set` of selected chapter and topic IDs.
    - Tapping a chapter selects/deselects all its topics.
    - The bottom bar shows the `TestConfigurationBottomSheet`.
    - It builds and passes `chapterIdToNameMap`, `topicIdToNameMap`, and `chapterIdToTopicsMap` to the configuration sheet.

### `TestConfigurationBottomSheet`
- **File:** `lib/widgets/test_configuration_bottom_sheet.dart`
- **Purpose:** Configures parameters for a new test.
- **UI:** Modal bottom sheet with a `TextField` for Test Name, `ChoiceChip`s for preset question counts, a "Custom" option, and a time limit adjuster.
- **Logic:**
    - On "Generate Test" press, calls `TestService().generateTest()`.
    - Builds a nested `selectedSyllabus` map of human-readable chapter and topic names.
    - Navigates to the `TestPreviewScreen` with the generated questions and syllabus data.

### `TestPreviewScreen`
- **File:** `lib/test_preview_screen.dart`
- **Purpose:** Confirmation step before saving or starting a test.
- **UI:** A summary of the test (name, Qs, time) and a nested list of included chapters and topics.
- **Logic:**
    - "Attempt later" button calls `TestOrchestrationService().createAndSaveTestBlueprint()` to save the test with status "Not Attempted".
    - "Attempt now" button also saves the blueprint, then immediately navigates to `TestScreen`, passing the new test ID.

### `TestScreen`
- **File:** `lib/test_screen.dart`
- **Purpose:** The live exam interface.
- **UI:** `AppBar` with countdown timer and "Submit" button. A compact, horizontally scrollable question "palette". A `PageView` for questions. A 2x2 grid of action buttons at the bottom ("Previous", "Save & Next", etc.).
- **Logic:**
    - Manages a `Map<int, AnswerState>` for question status and answers.
    - Manages a `Map<int, Stopwatch>` to track time spent on each individual question.
    - The final "Submit" button triggers a confirmation dialog.
    - On confirmed submission, it calls `TestOrchestrationService().saveTestAttempt()` and navigates to `ResultsScreen`.

### `ResultsScreen`
- **File:** `lib/screens/results_screen.dart`
- **Purpose:** Provides a detailed performance breakdown after a test.
- **UI:** A score card, key stats row (Accuracy, Attempt %), a donut chart with legend, and a "Review Solutions" grid.
- **Logic:**
    - Calculates all metrics from the `TestResult` object passed to it.
    - Tapping a number in the review grid opens the `SolutionDetailSheet`.

### `SolutionDetailSheet`
- **File:** `lib/widgets/solution_detail_sheet.dart`
- **Purpose:** To show the detailed solution for a single question.
- **UI:** A `PageView` to allow swiping between solutions. Shows the question image, the user's answer, the correct answer, the formatted time spent on the question, and the solution image.
- **Logic:** Navigates between questions using a `PageController`.
